let fs = require('fs-extra');
let glob = require('glob-all');
let inlineCSS = require('juice');
let cheerio = require('cheerio');
let cleanCSS = require('email-remove-unused-css');
let pretty = require('pretty');
let minify = require('html-minifier').minify;
let sixHex = require('color-shorthand-hex-to-six-digit');
let altText = require('html-img-alt');

module.exports.processEmails = (config, build_path) => {

  let files = glob.sync([build_path+'/**/*.html']);
  let extraCss = fs.readFileSync('source/assets/css/extra.css', 'utf8');

  files.map((file) => {

    let html = fs.readFileSync(file, 'utf8');

    html = inlineCSS(html);
    html = cleanCSS(html).result;

    let $ = cheerio.load(html, {decodeEntities: false});
    let style = $('style').first();
    style.html(extraCss + style.text());
    html = $.html();

    html = pretty(html, {ocd: true, indent_inner_html: false});

    if (config.minify && config.minify.html) {
      html = minify(html, {
        html5: false,
        maxLineLength: 500,
        keepClosingSlash: true,
        collapseWhitespace: true,
        // preserveLineBreaks: true,
        includeAutoGeneratedTags: false,
        // processConditionalComments: true,
        minifyCSS: config.minify.css ? true : false
      });
    }

    html = sixHex(html);
    html = altText(html);

    fs.writeFileSync(file, html);

  });

  if (fs.existsSync(build_path+'/assets')) { fs.removeSync(build_path+'/assets') }
}
